# AI èŠå¤©æµå¼è¿”å›æ¼”ç¤º - ä½¿ç”¨æŒ‡å—

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„ AI èŠå¤©æµå¼è¿”å›æ¼”ç¤ºé¡¹ç›®ï¼Œå±•ç¤ºäº†ä¸¤ç§ä¸»æµçš„å®æ—¶é€šä¿¡æŠ€æœ¯ï¼š

1. **SSE (Server-Sent Events)** - é€‚åˆå•å‘æ•°æ®æµ
2. **WebSocket** - é€‚åˆåŒå‘å®æ—¶é€šä¿¡

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¬¬ä¸€æ­¥ï¼šå®‰è£…ä¾èµ–

```bash
cd ai_chat
pnpm install
# æˆ–è€…ä½¿ç”¨ npm install
```

### ç¬¬äºŒæ­¥ï¼šå¯åŠ¨æœåŠ¡å™¨

```bash
npm run dev
```

çœ‹åˆ°ä»¥ä¸‹è¾“å‡ºè¡¨ç¤ºå¯åŠ¨æˆåŠŸï¼š

```
> Ready on http://localhost:3000
> Socket.IO server running on path: /api/socketio
```

### ç¬¬ä¸‰æ­¥ï¼šè®¿é—®åº”ç”¨

æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼šhttp://localhost:3000

## ğŸ® åŠŸèƒ½æ¼”ç¤º

### æ–¹æ³•é€‰æ‹©

é¡µé¢é¡¶éƒ¨å¯ä»¥åˆ‡æ¢ä¸¤ç§é€šä¿¡æ–¹å¼ï¼š

- **SSE** - ç‚¹å‡»æŸ¥çœ‹ Server-Sent Events å®ç°
- **WebSocket** - ç‚¹å‡»æŸ¥çœ‹ WebSocket å®ç°

### èŠå¤©åŠŸèƒ½

1. åœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥æ¶ˆæ¯
2. æŒ‰ Enter å‘é€ï¼Œæˆ–ç‚¹å‡»"å‘é€"æŒ‰é’®
3. è§‚å¯Ÿ AI å›å¤çš„æµå¼æ•ˆæœï¼ˆé€å­—æ˜¾ç¤ºï¼‰
4. æŸ¥çœ‹è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### SSE å®ç°è¦ç‚¹

#### å®¢æˆ·ç«¯ï¼ˆSSEChat.jsï¼‰

```javascript
// å»ºç«‹SSEè¿æ¥
const eventSource = new EventSource('/api/chat/sse?message=' + encodeURIComponent(input));

// ç›‘å¬æ¶ˆæ¯
eventSource.onmessage = (event) => {
  const data = JSON.parse(event.data);
  if (data.type === 'token') {
    // å¤„ç†æ–°çš„æ–‡æœ¬ç‰‡æ®µ
    currentMessageRef.current += data.content;
    setMessages((prev) =>
      prev.map((msg) => (msg.id === aiMessageId ? { ...msg, text: currentMessageRef.current } : msg))
    );
  }
};
```

#### æœåŠ¡ç«¯ï¼ˆ/api/chat/sse/route.jsï¼‰

```javascript
// åˆ›å»ºæµå¼å“åº”
const stream = new ReadableStream({
  start(controller) {
    const tokens = tokenizeResponse(message);
    const sendToken = () => {
      if (index < tokens.length) {
        const data = JSON.stringify({
          type: 'token',
          content: tokens[index],
          index: index,
        });
        controller.enqueue(encoder.encode(`data: ${data}\n\n`));
        setTimeout(sendToken, randomDelay);
      }
    };
    sendToken();
  },
});
```

### WebSocket å®ç°è¦ç‚¹

#### å®¢æˆ·ç«¯ï¼ˆWebSocketChat.jsï¼‰

```javascript
// å»ºç«‹WebSocketè¿æ¥
const newSocket = io('/api/socketio');

// å‘é€æ¶ˆæ¯
socket.emit('user_message', {
  message: input,
  timestamp: new Date().toISOString(),
});

// ç›‘å¬AIå›å¤
socket.on('ai_response_token', (data) => {
  currentMessageRef.current += data.token;
  setMessages((prev) =>
    prev.map((msg) => (msg.id === data.messageId ? { ...msg, text: currentMessageRef.current } : msg))
  );
});
```

#### æœåŠ¡ç«¯ï¼ˆserver.jsï¼‰

```javascript
// Socket.IOæœåŠ¡å™¨
io.on('connection', (socket) => {
  socket.on('user_message', async (data) => {
    const tokens = tokenizeResponse(data.message);

    // é€ä¸ªå‘é€tokens
    for (let i = 0; i < tokens.length; i++) {
      socket.emit('ai_response_token', {
        messageId: messageId,
        token: tokens[i],
        index: i,
      });
      await new Promise((resolve) => setTimeout(resolve, randomDelay));
    }
  });
});
```

## ğŸ¨ ç•Œé¢è¯´æ˜

### çŠ¶æ€æŒ‡ç¤ºå™¨

- ğŸŸ¢ **å·²è¿æ¥** - ç»¿è‰²åœ†ç‚¹ï¼Œæ­£å¸¸é€šä¿¡
- ğŸŸ¡ **è¿æ¥ä¸­** - é»„è‰²åœ†ç‚¹ï¼Œæ­£åœ¨å»ºç«‹è¿æ¥
- ğŸ”´ **è¿æ¥é”™è¯¯** - çº¢è‰²åœ†ç‚¹ï¼Œè¿æ¥å¤±è´¥
- âš« **æœªè¿æ¥** - ç°è‰²åœ†ç‚¹ï¼Œæ–­å¼€è¿æ¥

### æ¶ˆæ¯æ˜¾ç¤º

- **ç”¨æˆ·æ¶ˆæ¯** - è“è‰²æ°”æ³¡ï¼Œå³å¯¹é½
- **AI æ¶ˆæ¯** - ç°è‰²æ°”æ³¡ï¼Œå·¦å¯¹é½
- **æµå¼æ•ˆæœ** - æ˜¾ç¤ºé—ªçƒå…‰æ ‡"|"è¡¨ç¤ºæ­£åœ¨è¾“å…¥

### äº¤äº’å…ƒç´ 

- **è¾“å…¥æ¡†** - æ”¯æŒå¤šè¡Œè¾“å…¥ï¼ŒEnter å‘é€ï¼ŒShift+Enter æ¢è¡Œ
- **å‘é€æŒ‰é’®** - ç¦ç”¨çŠ¶æ€æ˜¾ç¤º"å‘é€ä¸­..."
- **é‡è¿æŒ‰é’®** - ä»…åœ¨ WebSocket æ–­å¼€æ—¶æ˜¾ç¤º

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| ç‰¹æ€§       | SSE                     | WebSocket        |
| ---------- | ----------------------- | ---------------- |
| è¿æ¥æ–¹å¼   | HTTP é•¿è¿æ¥             | TCP è¿æ¥         |
| é€šä¿¡æ–¹å‘   | å•å‘ï¼ˆæœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ï¼‰ | åŒå‘             |
| åè®®å¼€é”€   | è¾ƒé«˜ï¼ˆHTTP å¤´ï¼‰         | è¾ƒä½             |
| å®ç°å¤æ‚åº¦ | ç®€å•                    | ä¸­ç­‰             |
| æµè§ˆå™¨æ”¯æŒ | å¥½                      | å¾ˆå¥½             |
| è‡ªåŠ¨é‡è¿   | å†…ç½®                    | éœ€æ‰‹åŠ¨å®ç°       |
| é€‚ç”¨åœºæ™¯   | å®æ—¶æ¨é€ã€é€šçŸ¥          | èŠå¤©ã€æ¸¸æˆã€åä½œ |

## ğŸ› ï¸ è‡ªå®šä¹‰é…ç½®

### ä¿®æ”¹ AI å›å¤å†…å®¹

åœ¨ä»¥ä¸‹ä½ç½®ä¿®æ”¹å›å¤æ¨¡æ¿ï¼š

```javascript
// SSEç‰ˆæœ¬ï¼šsrc/app/api/chat/sse/route.js
// WebSocketç‰ˆæœ¬ï¼šserver.js
const AI_RESPONSES = [
  'è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é—®é¢˜ï¼',
  'æ ¹æ®ä½ çš„æè¿°ï¼Œæˆ‘è®¤ä¸º',
  // æ·»åŠ æ›´å¤šå›å¤...
];
```

### è°ƒæ•´æµå¼é€Ÿåº¦

```javascript
// ä¿®æ”¹å»¶è¿Ÿæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
const delay = Math.random() * 100 + 50; // 50-150ms
```

### è‡ªå®šä¹‰æ ·å¼

ç¼–è¾‘ä»¥ä¸‹æ–‡ä»¶ï¼š

- `src/components/Chat.module.css` - èŠå¤©ç»„ä»¶æ ·å¼
- `src/app/page.module.css` - ä¸»é¡µé¢æ ·å¼
- `src/app/globals.css` - å…¨å±€æ ·å¼

## ğŸš¨ å¸¸è§é—®é¢˜

### Q: WebSocket è¿æ¥å¤±è´¥æ€ä¹ˆåŠï¼Ÿ

A: ç¡®ä¿ä½¿ç”¨ `npm run dev` å¯åŠ¨ï¼ˆåŒ…å« Socket.IO æœåŠ¡å™¨ï¼‰ï¼Œè€Œä¸æ˜¯ `npm run dev-next`

### Q: SSE æ–­å¼€åå¦‚ä½•é‡è¿ï¼Ÿ

A: SSE æœ‰å†…ç½®çš„è‡ªåŠ¨é‡è¿æœºåˆ¶ï¼Œé€šå¸¸ä¼šè‡ªåŠ¨å°è¯•é‡è¿

### Q: å¦‚ä½•ä¿®æ”¹ç«¯å£ï¼Ÿ

A: è®¾ç½®ç¯å¢ƒå˜é‡ `PORT=4000 npm run dev`

### Q: ç”Ÿäº§ç¯å¢ƒå¦‚ä½•éƒ¨ç½²ï¼Ÿ

A:

1. è¿è¡Œ `npm run build` æ„å»ºé¡¹ç›®
2. è¿è¡Œ `npm start` å¯åŠ¨ç”Ÿäº§æœåŠ¡å™¨
3. é…ç½®åå‘ä»£ç†ï¼ˆNginxï¼‰å¤„ç† Socket.IO è·¯å¾„

### Q: å¦‚ä½•é›†æˆçœŸå®çš„ AI APIï¼Ÿ

A: æ›¿æ¢ `tokenizeResponse` å‡½æ•°ï¼Œè°ƒç”¨çœŸå®çš„ AI æœåŠ¡ï¼ˆå¦‚ OpenAIã€Claude ç­‰ï¼‰

## ğŸ“– æ‰©å±•å»ºè®®

### 1. æ·»åŠ ç”¨æˆ·è®¤è¯

```javascript
// åœ¨Socket.IOè¿æ¥æ—¶éªŒè¯token
io.use((socket, next) => {
  const token = socket.handshake.auth.token;
  // éªŒè¯tokené€»è¾‘
  next();
});
```

### 2. æ¶ˆæ¯æŒä¹…åŒ–

```javascript
// ä½¿ç”¨æ•°æ®åº“å­˜å‚¨èŠå¤©è®°å½•
const message = await db.messages.create({
  userId: socket.userId,
  content: data.message,
  timestamp: new Date(),
});
```

### 3. å¤šæˆ¿é—´æ”¯æŒ

```javascript
// åŠ å…¥ç‰¹å®šæˆ¿é—´
socket.join(roomId);
// å‘æˆ¿é—´å‘é€æ¶ˆæ¯
io.to(roomId).emit('message', data);
```

### 4. æ–‡ä»¶ä¸Šä¼ 

```javascript
// æ”¯æŒå›¾ç‰‡å’Œæ–‡ä»¶å‘é€
socket.on('file_upload', (fileData) => {
  // å¤„ç†æ–‡ä»¶ä¸Šä¼ é€»è¾‘
});
```

## ğŸ”— ç›¸å…³èµ„æº

- [MDN - Server-Sent Events](https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events)
- [Socket.IO å®˜æ–¹æ–‡æ¡£](https://socket.io/docs/)
- [Next.js API Routes](https://nextjs.org/docs/api-routes/introduction)
- [WebSocket API](https://developer.mozilla.org/en-US/docs/Web/API/WebSocket)

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Request æ”¹è¿›é¡¹ç›®ï¼

1. Fork é¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
3. æäº¤æ›´æ”¹
4. å‘èµ· Pull Request

---

**é¡¹ç›®åœ°å€**: https://github.com/your-username/ai_chat
**ä½œè€…**: Your Name
**è®¸å¯è¯**: MIT

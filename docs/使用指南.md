# AI 聊天流式返回演示 - 使用指南

## 🎯 项目概述

这是一个完整的 AI 聊天流式返回演示项目，展示了两种主流的实时通信技术：

1. **SSE (Server-Sent Events)** - 适合单向数据流
2. **WebSocket** - 适合双向实时通信

## 🚀 快速开始

### 第一步：安装依赖

```bash
cd ai_chat
pnpm install
# 或者使用 npm install
```

### 第二步：启动服务器

```bash
npm run dev
```

看到以下输出表示启动成功：

```
> Ready on http://localhost:3000
> Socket.IO server running on path: /api/socketio
```

### 第三步：访问应用

打开浏览器访问：http://localhost:3000

## 🎮 功能演示

### 方法选择

页面顶部可以切换两种通信方式：

- **SSE** - 点击查看 Server-Sent Events 实现
- **WebSocket** - 点击查看 WebSocket 实现

### 聊天功能

1. 在输入框中输入消息
2. 按 Enter 发送，或点击"发送"按钮
3. 观察 AI 回复的流式效果（逐字显示）
4. 查看连接状态指示器

## 🔧 技术细节

### SSE 实现要点

#### 客户端（SSEChat.js）

```javascript
// 建立SSE连接
const eventSource = new EventSource('/api/chat/sse?message=' + encodeURIComponent(input));

// 监听消息
eventSource.onmessage = (event) => {
  const data = JSON.parse(event.data);
  if (data.type === 'token') {
    // 处理新的文本片段
    currentMessageRef.current += data.content;
    setMessages((prev) =>
      prev.map((msg) => (msg.id === aiMessageId ? { ...msg, text: currentMessageRef.current } : msg))
    );
  }
};
```

#### 服务端（/api/chat/sse/route.js）

```javascript
// 创建流式响应
const stream = new ReadableStream({
  start(controller) {
    const tokens = tokenizeResponse(message);
    const sendToken = () => {
      if (index < tokens.length) {
        const data = JSON.stringify({
          type: 'token',
          content: tokens[index],
          index: index,
        });
        controller.enqueue(encoder.encode(`data: ${data}\n\n`));
        setTimeout(sendToken, randomDelay);
      }
    };
    sendToken();
  },
});
```

### WebSocket 实现要点

#### 客户端（WebSocketChat.js）

```javascript
// 建立WebSocket连接
const newSocket = io('/api/socketio');

// 发送消息
socket.emit('user_message', {
  message: input,
  timestamp: new Date().toISOString(),
});

// 监听AI回复
socket.on('ai_response_token', (data) => {
  currentMessageRef.current += data.token;
  setMessages((prev) =>
    prev.map((msg) => (msg.id === data.messageId ? { ...msg, text: currentMessageRef.current } : msg))
  );
});
```

#### 服务端（server.js）

```javascript
// Socket.IO服务器
io.on('connection', (socket) => {
  socket.on('user_message', async (data) => {
    const tokens = tokenizeResponse(data.message);

    // 逐个发送tokens
    for (let i = 0; i < tokens.length; i++) {
      socket.emit('ai_response_token', {
        messageId: messageId,
        token: tokens[i],
        index: i,
      });
      await new Promise((resolve) => setTimeout(resolve, randomDelay));
    }
  });
});
```

## 🎨 界面说明

### 状态指示器

- 🟢 **已连接** - 绿色圆点，正常通信
- 🟡 **连接中** - 黄色圆点，正在建立连接
- 🔴 **连接错误** - 红色圆点，连接失败
- ⚫ **未连接** - 灰色圆点，断开连接

### 消息显示

- **用户消息** - 蓝色气泡，右对齐
- **AI 消息** - 灰色气泡，左对齐
- **流式效果** - 显示闪烁光标"|"表示正在输入

### 交互元素

- **输入框** - 支持多行输入，Enter 发送，Shift+Enter 换行
- **发送按钮** - 禁用状态显示"发送中..."
- **重连按钮** - 仅在 WebSocket 断开时显示

## 📊 性能对比

| 特性       | SSE                     | WebSocket        |
| ---------- | ----------------------- | ---------------- |
| 连接方式   | HTTP 长连接             | TCP 连接         |
| 通信方向   | 单向（服务器 → 客户端） | 双向             |
| 协议开销   | 较高（HTTP 头）         | 较低             |
| 实现复杂度 | 简单                    | 中等             |
| 浏览器支持 | 好                      | 很好             |
| 自动重连   | 内置                    | 需手动实现       |
| 适用场景   | 实时推送、通知          | 聊天、游戏、协作 |

## 🛠️ 自定义配置

### 修改 AI 回复内容

在以下位置修改回复模板：

```javascript
// SSE版本：src/app/api/chat/sse/route.js
// WebSocket版本：server.js
const AI_RESPONSES = [
  '这是一个很好的问题！',
  '根据你的描述，我认为',
  // 添加更多回复...
];
```

### 调整流式速度

```javascript
// 修改延迟时间（毫秒）
const delay = Math.random() * 100 + 50; // 50-150ms
```

### 自定义样式

编辑以下文件：

- `src/components/Chat.module.css` - 聊天组件样式
- `src/app/page.module.css` - 主页面样式
- `src/app/globals.css` - 全局样式

## 🚨 常见问题

### Q: WebSocket 连接失败怎么办？

A: 确保使用 `npm run dev` 启动（包含 Socket.IO 服务器），而不是 `npm run dev-next`

### Q: SSE 断开后如何重连？

A: SSE 有内置的自动重连机制，通常会自动尝试重连

### Q: 如何修改端口？

A: 设置环境变量 `PORT=4000 npm run dev`

### Q: 生产环境如何部署？

A:

1. 运行 `npm run build` 构建项目
2. 运行 `npm start` 启动生产服务器
3. 配置反向代理（Nginx）处理 Socket.IO 路径

### Q: 如何集成真实的 AI API？

A: 替换 `tokenizeResponse` 函数，调用真实的 AI 服务（如 OpenAI、Claude 等）

## 📖 扩展建议

### 1. 添加用户认证

```javascript
// 在Socket.IO连接时验证token
io.use((socket, next) => {
  const token = socket.handshake.auth.token;
  // 验证token逻辑
  next();
});
```

### 2. 消息持久化

```javascript
// 使用数据库存储聊天记录
const message = await db.messages.create({
  userId: socket.userId,
  content: data.message,
  timestamp: new Date(),
});
```

### 3. 多房间支持

```javascript
// 加入特定房间
socket.join(roomId);
// 向房间发送消息
io.to(roomId).emit('message', data);
```

### 4. 文件上传

```javascript
// 支持图片和文件发送
socket.on('file_upload', (fileData) => {
  // 处理文件上传逻辑
});
```

## 🔗 相关资源

- [MDN - Server-Sent Events](https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events)
- [Socket.IO 官方文档](https://socket.io/docs/)
- [Next.js API Routes](https://nextjs.org/docs/api-routes/introduction)
- [WebSocket API](https://developer.mozilla.org/en-US/docs/Web/API/WebSocket)

## 🤝 贡献

欢迎提交 Issue 和 Pull Request 改进项目！

1. Fork 项目
2. 创建功能分支
3. 提交更改
4. 发起 Pull Request

---

**项目地址**: https://github.com/your-username/ai_chat
**作者**: Your Name
**许可证**: MIT
